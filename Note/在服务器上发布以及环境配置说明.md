# 在服务器上发布以及环境配置说明

## 1.服务器的获取与配置

### 1.1 服务器的获取

国内外很多厂商有云端服务器可用，各厂商服务器均可，本例子中使用vultr的云服务器，价格较低。

vultr网址：[https://my.vultr.com](https://my.vultr.com)

注册后需要充值10美金，这里感觉还是挺实惠的……在该页面选取服务器类型：

![](/home/liuqihan/文档/看图说话机器人项目检测/404 Not Found/第一周演示ppt/vultr.png)

（1）推荐亚洲地区选择日本新加坡等地，延迟会比较低。

（2）操作系统选择比较熟悉的，我这里选择了和程序运行环境相匹配的ubuntu18.04

（3）服务器规模选择了3.5美金的，2.5美金的只有IPV6协议，后续还需要额外链接IPV4就很不方便。（在上面运行较大的程序时512m的内存并不充足，我们需要自己设置交换区增加虚拟内存，后续会详细说明）

（4）下面其他选项不需要填选任何东西，直接确定就行。（如果不是你的第一个服务器，你也可以直接更一些设置比如防火墙，ssh秘钥等）。



### 1.2 服务器配置

接下来我们需要配置防火墙设置，暴露端口，并且根据系统需要，在服务器上安装运行环境。

#### 1.2.1防火墙设置

进入服务器页面，观察到服务器已经在运行，之后进入防火墙选项卡（Firewall）进行设置。



![](/home/liuqihan/文档/看图说话机器人项目检测/404 Not Found/第一周演示ppt/服务器运行页面.png)



![](/home/liuqihan/文档/看图说话机器人项目检测/404 Not Found/第一周演示ppt/2018-11-30 22-40-18屏幕截图.png)



（1）第一步，配以一个防火墙规则组：进入后Firewall选项卡之后，ssh协议默认端口为22（vultr网站的默认设置，且无法更改），点击加号增加规则到防火墙规则组中。图中我们额外增加了http协议的5000端口作为系统的端口来使用（系统启动时默认端口为5000），其他端口视情况可自行增加。其中anywhere选项（0.0.0.0/0）意味着任何地点任何ip都可以使用你刚刚启用的端口。（这里ssh协议用来连接服务器配置服务器，所以为了安全起见，可以把允许访问的ip地址设置为本机ip）。

（2）第二步，点击下方的linked instances，将防火墙规则组配置到你的服务器，如下图所示，即为配置成功。

![](/home/liuqihan/文档/看图说话机器人项目检测/404 Not Found/第一周演示ppt/2018-11-30 22-50-05屏幕截图.png)

####  1.2.2 从ubuntu连接服务器以及环境配置

> 这里我们使用ubuntu链接服务器，你也可以使用其他系统连接服务器。

（1）连接服务器，使用我们刚才开放的ssh协议22号端口。首先确认服务器在运行状态，我们要使用IP地址，用户名，服务器密码，在本地ubuntu系统上打开终端，假设服务器地址为8.8.8.8使用命令：

```bash
sudo ssh -t root@8.8.8.8 -p 22
```

连接上之后会有警告，属于正常，在提示后输入你的密码，回车即可登录到你的服务器。（如果无法连接，请检查是否输入错误，密码过于复杂可直接复制，右键粘贴）

如果确认输入正确依旧无法连接，可能是ip地址延迟过高或者被墙掉，可以使用ping+ip地址的命令来查看服务器地址是否可以连通，若IP地址为8.8.8.8命令如下：

```bash
ping 8.8.8.8
```

如果无法连通，请返回第一步，重新建立其他国家服务器进行后续操作。

（2）配置程序需要的环境，（ubuntu18.04自带python3，如果用其他程序，请先安装python3）自行安装tensorflow，OpenCV2,flask

安装时使用命令：

```bash
pip3 install --no-cache-dir tensorflow opencv-python flask
```

我们使用pip3来将程序安装到python3的环境下。这里面的参数--no-cache-dir是因为服务器内存很小，所以我们采用不保存pip缓存的模式来安装，否则可能会报错。如果运行行为缺少模块，可尝试安装相应模块后再运行，也可使用”pip3 install --no-cache-dir 软件包名字“的安装命令来安装补齐。

#### 1.2.3设置虚拟内存

由于我们启动的服务器内存较小，因此我们通过设置虚拟内存来增大内存空间，运行本系统大概需要4G空间，依次执行下列命令：

```bash
解决方案 ：swap 设置虚拟内存
ubuntu18.04默认的swap文件在根目录/下，名字是swapfile
1.查看交换分区大小
free -m 
#在创建完毕后也可以用这个命令查看内存情况
#2.创建一个swap文件
sudo dd if=/dev/zero of=swap bs=1024 count=4000000
#创建的交换文件名是swap，后面的40000000是4g的意思，可以按照自己的需要更改
#3.创建swap文件系统
sudo mkswap -f swap
#4.开启swap
sudo swapon swap
#5.关闭和删除原来的swapfile
sudo swapoff  swapfile
sudo rm /swapfile
#6.设置开机启动
sudo vim /etc/fstab
#按一下i键，进入插入编辑模式，将里面的swapfile改为swap
#vim编辑器编辑完毕之后，按一下esc键，再按shift+；（冒号），输入qw，回车即可保存退出。
```



## 2. 系统的布置

### 2.1 系统文件的上传

系统的文件置于im2txt文件中假设将其下载的地址为/download/im2txt.gz，使用下列命令将压缩包上传至服务器的workspace目录下：

```bash
mkdir workspace
scp /download/im2txt.gz root@8.8.8.8 /workspace
```

使用如下命令对压缩包进行解压：

```bash
tar  -zxvf   压缩文件名
```

### 2.2系统运行

在例子中，我们将系统布置到workspace文件夹中

执行cd命令，进入im2txt文件夹中：

```bash
cd /workspace/im2txt
```

执行python文件display.py:

```
nohup python3 display.py &
```

这里我们使用python3运行程序，利用nohup命令使程序命令无视终端挂起信号，可以后台运行。

运行成功后，程序显示暴露端口为5000.

## 3.程序的使用

在任意浏览器中，打开如下格式的网址,假设服务器地址为8.8.8.8：

http://8.8.8.8:5000，即可使用本程序。

首先选择翻译语言，本系统支持中英两种语言。

其次选择上传的照片点击上传，上传会花费一定的时间，请耐心等待。

最后页面会输出结果。

![](/home/liuqihan/文档/看图说话机器人项目检测/404 Not Found/第一周演示ppt/2018-12-01 08-34-38屏幕截图.png)



注：支持上传的文件格式为jpg格式，如果格式错误将会提示请上传正确格式的文件。





